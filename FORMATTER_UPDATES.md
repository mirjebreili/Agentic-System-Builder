# Formatter Updates - Display All Plans with Confidence

## Summary
Modified the formatter to display all alternative plans generated by `plan_tot` along with their confidence scores, not just the selected plan.

## Changes Made

### 1. State Definition (`src/agents/state.py`)
- **Added**: `debug` field to `AppState` to store debug information including all plan candidates
- **Type**: `Annotated[Dict[str, Any], operator.or_]`
- **Purpose**: Stores `plan_candidates` array from the planner for downstream access

### 2. Formatter Function (`src/agents/formatter.py`)
- **Updated**: `format_plan_order()` function to:
  - Extract all plan candidates from `state["debug"]["plan_candidates"]`
  - Create a data structure containing both selected plan and all alternatives
  - Pass this information to the LLM for formatting
  - Include count of alternative plans in logging

- **Updated**: `_fallback_format()` function to:
  - Accept optional `all_candidates` parameter
  - Display an "ALTERNATIVE PLANS" section when multiple plans exist
  - Show confidence score, step count, and first tool for each alternative
  - Mark the selected plan with `[SELECTED]` tag

### 3. Prompt Template (`src/prompts/format_user.jinja`)
- **Updated**: Instructions to handle new data structure:
  - Explain that `plan_json` contains `selected_plan` and `all_plans`
  - Request formatting of alternative plans summary section
  - Request clear marking of which plan was selected
  - Request display of confidence, steps, and first tool for each alternative

## How It Works

1. **Planner** (`plan_tot`) generates K=3 alternative plans and stores them in `state["debug"]["plan_candidates"]`
2. **Formatter** retrieves both the selected plan and all candidates
3. **LLM** formats the output to show:
   - Selected plan details (goal, confidence, steps)
   - All alternative plans with their scores
   - Detailed execution sequence for the selected plan
4. **Fallback** function provides similar formatting if LLM fails

## Data Flow

```
plan_tot (planner.py)
  ↓ Generates 3 plans
  ↓ Selects best by confidence
  ↓ Stores all in state["debug"]["plan_candidates"]
  
format_plan_order (formatter.py)
  ↓ Retrieves selected plan from state["plan"]
  ↓ Retrieves all candidates from state["debug"]["plan_candidates"]
  ↓ Creates format_data = {selected_plan, all_plans}
  ↓ Sends to LLM for formatting
  
Output
  ↓ Shows selected plan with full details
  ↓ Shows all alternatives with confidence scores
  ↓ User can see all options that were considered
```

## Example Output Structure

```
============================================================
PLAN EXECUTION ORDER
============================================================

Goal: [User's goal]
Confidence: 0.85

------------------------------------------------------------
ALTERNATIVE PLANS
------------------------------------------------------------

Plan 1 [SELECTED]:
  Confidence: 0.85
  Steps: 3
  First Tool: analyze_data

Plan 2:
  Confidence: 0.72
  Steps: 4
  First Tool: preprocess_data

Plan 3:
  Confidence: 0.68
  Steps: 2
  First Tool: simple_calc

------------------------------------------------------------
EXECUTION SEQUENCE:
------------------------------------------------------------

Step 1: node_1
  Type: Tool Execution
  Tool: analyze_data
  Next: node_2
  
[... more steps ...]

============================================================
END OF PLAN
============================================================
```

## Benefits

1. **Transparency**: Users can see all plans that were considered
2. **Confidence**: Shows why one plan was chosen over others
3. **Debugging**: Easier to understand planner behavior
4. **Trust**: Users can verify the selection logic

## Testing

To test the changes:
1. Run a query that triggers `plan_tot`
2. Check that the formatted output includes an "ALTERNATIVE PLANS" section
3. Verify that all plans show their confidence scores
4. Confirm the selected plan is clearly marked
