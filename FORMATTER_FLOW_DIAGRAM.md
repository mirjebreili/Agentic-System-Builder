# Formatter Node - Visual Flow Diagram

## Complete Workflow with Formatter

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AGENTIC SYSTEM WORKFLOW                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              START
                                â”‚
                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   plan_tot    â”‚
                        â”‚               â”‚
                        â”‚ â€¢ Generate K  â”‚
                        â”‚   alternative â”‚
                        â”‚   plans (ToT) â”‚
                        â”‚ â€¢ Validate    â”‚
                        â”‚ â€¢ Select best â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  confidence   â”‚
                        â”‚               â”‚
                        â”‚ â€¢ Compute     â”‚
                        â”‚   confidence  â”‚
                        â”‚   score       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ review_plan   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   (HITL)      â”‚           â”‚
                        â”‚               â”‚           â”‚
                        â”‚ â€¢ Interrupt   â”‚           â”‚
                        â”‚ â€¢ Wait human  â”‚           â”‚
                        â”‚ â€¢ Resume      â”‚           â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                â”‚                   â”‚
                                â–¼                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                        â”‚ route_after   â”‚           â”‚
                        â”‚   _review     â”‚           â”‚
                        â”‚               â”‚           â”‚
                        â”‚ Decision:     â”‚           â”‚
                        â”‚ replan?       â”‚           â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                â”‚                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                        â”‚               â”‚           â”‚
                  replan=True     replan=False      â”‚
                        â”‚               â”‚           â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                                    â”‚
                                â–¼                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                    â”‚ format_plan_order   â”‚         â”‚
                    â”‚    ğŸ†• NEW NODE      â”‚         â”‚
                    â”‚                     â”‚         â”‚
                    â”‚ â€¢ Load prompts      â”‚         â”‚
                    â”‚ â€¢ Prepare plan JSON â”‚         â”‚
                    â”‚ â€¢ Invoke LLM        â”‚         â”‚
                    â”‚ â€¢ Generate text     â”‚         â”‚
                    â”‚ â€¢ Store in state    â”‚         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                               â”‚                    â”‚
                               â–¼                    â”‚
                              END                   â”‚
                                                    â”‚
                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## Formatter Node Internal Flow

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      format_plan_order Function                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Input: state (with approved plan)
       â”‚
       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Extract plan from   â”‚
    â”‚ state               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Get LLM client      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Convert plan to     â”‚
    â”‚ JSON string         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Load & render       â”‚
    â”‚ prompts:            â”‚
    â”‚ â€¢ format_system     â”‚
    â”‚ â€¢ format_user       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Invoke LLM          â”‚
    â”‚                     â”‚
    â”‚ System: "You are an â”‚
    â”‚  expert technical   â”‚
    â”‚  writer..."         â”‚
    â”‚                     â”‚
    â”‚ User: "Format this  â”‚
    â”‚  plan: {...}"       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚
    Success?        Error?
       â”‚               â”‚
       â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ LLM â”‚      â”‚ _fallback_  â”‚
    â”‚text â”‚      â”‚  format()   â”‚
    â””â”€â”€â”¬â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Clean up markdown   â”‚
    â”‚ code fences         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Add to messages     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Store in scratch    â”‚
    â”‚ ['formatted_plan_   â”‚
    â”‚  order']            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    Output: Updated state


## Data Flow

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   State In   â”‚
â”‚              â”‚
â”‚ â€¢ plan: {    â”‚
â”‚    goal,     â”‚
â”‚    nodes,    â”‚
â”‚    edges,    â”‚
â”‚    confidenceâ”‚
â”‚   }          â”‚
â”‚ â€¢ messages   â”‚
â”‚ â€¢ scratch    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Formatter Node  â”‚
â”‚                  â”‚
â”‚  Uses:           â”‚
â”‚  â€¢ LLM client    â”‚
â”‚  â€¢ Prompts from  â”‚
â”‚    src/prompts/  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  State Out   â”‚
â”‚              â”‚
â”‚ â€¢ plan       â”‚ (unchanged)
â”‚ â€¢ messages   â”‚ (+ formatted text)
â”‚ â€¢ scratch    â”‚ (+ formatted_plan_order)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## Files Architecture

src/
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ formatter.py        ğŸ†• Formatter node implementation
â”‚   â”œâ”€â”€ graph.py            âœï¸  Updated with formatter
â”‚   â”œâ”€â”€ planner.py          (existing)
â”‚   â”œâ”€â”€ confidence.py       (existing)
â”‚   â””â”€â”€ hitl.py            (existing)
â”‚
â”œâ”€â”€ prompts/
â”‚   â”œâ”€â”€ format_system.jinja ğŸ†• System prompt for formatter
â”‚   â”œâ”€â”€ format_user.jinja   ğŸ†• User prompt template
â”‚   â”œâ”€â”€ plan_system.jinja   (existing)
â”‚   â””â”€â”€ plan_user.jinja     (existing)
â”‚
â””â”€â”€ llm/
    â””â”€â”€ client.py           (existing - provides get_chat_model())


## Key Integration Points

1. **Import in graph.py**:
   from agents.formatter import format_plan_order

2. **Node registration**:
   g.add_node("format_plan_order", format_plan_order)

3. **Routing logic**:
   g.add_conditional_edges(
       "review_plan",
       route_after_review,
       {"plan_tot": "plan_tot", "format_plan_order": "format_plan_order"}
   )

4. **Final edge**:
   g.add_edge("format_plan_order", END)
```
